<ion-header>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/home"></ion-back-button>
    </ion-buttons>
    <ion-title>Marcadores</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <div class="week-header">
    <div class="round-status">
      {{ getRoundStatus() }}
      <ion-badge [color]="isLiveRound ? 'success' : isRoundFinished ? 'medium' : 'warning'" class="round-badge">
        {{ isLiveRound ? 'ACTIVA EN ESTOS MOMENTOS' : isRoundFinished ? 'FINALIZADA' : 'PROGRAMADA' }}
      </ion-badge>
    </div>
  </div>

  <app-rounds-selector
    [selectedRound]="selectedRound"
    [currentRound]="currentRound"
    [isLiveRound]="isLiveRound"
    (roundChange)="onRoundChange($event)">
  </app-rounds-selector>

  <!-- Total Points Card -->
  <div class="total-points" *ngIf="!loading && !error && matches.length > 0">
    <ion-card>
      <ion-card-content>
        <h2>Total de Puntos: {{ totalPoints }}</h2>
      </ion-card-content>
    </ion-card>
  </div>

  <div *ngIf="loading" class="loading-container">
    <ion-spinner></ion-spinner>
    <p>Cargando partidos...</p>
  </div>

  <ion-text color="warning" *ngIf="isRateLimited" class="rate-limit-warning">
    <ion-icon name="warning-outline"></ion-icon>
    <p>{{ error }}</p>
  </ion-text>

  <ion-text color="danger" *ngIf="error && !isRateLimited">
    <p>{{ error }}</p>
    <ion-button (click)="loadMatches()" size="small" fill="outline">
      Reintentar
    </ion-button>
  </ion-text>

  <div class="matches-container" *ngIf="!loading && !error">
    <ion-list>
      <ion-item *ngFor="let match of matches">
        <ion-card class="match-card">
          <ion-card-header>
            <ion-card-subtitle class="match-date">
              {{ match.date | date:'EEEE d MMMM, y':'':'es-MX' }} • {{ match.date | date:'h:mm a':'':'es-MX' }}
              <br>
              <small>{{ match.venue.name }}, {{ match.venue.city }}</small>
            </ion-card-subtitle>
            <ion-badge [class.live-status]="match.status.short === 'LIVE' || match.status.short === 'HT'"
                      [color]="match.status.short === 'LIVE' || match.status.short === 'HT' ? 'success' :
                              match.status.short === 'NS' ? 'warning' : 'medium'"
                      class="match-status">
              {{ getMatchStatus(match) }}
            </ion-badge>
          </ion-card-header>

          <ion-card-content>
            <div class="teams">
              <div class="team">
                <img [src]="match.homeTeamLogo" [alt]="match.homeTeam" class="team-logo">
                <div class="team-name">{{ match.homeTeam }}</div>
              </div>

              <div class="scores-container">
                <!-- Actual Score -->
                <div class="final-score">
                  {{ match.status.short === 'NS' ? '' : (match.homeScore ?? '') }} {{ match.status.short === 'NS' ? '' : '-' }} {{ match.status.short === 'NS' ? '' : (match.awayScore ?? '') }}
                </div>

                <!-- Prediction Score -->
                <div class="prediction-score" [ngClass]="getPredictionClass(match)" *ngIf="match.prediction">
                  Tu Pronóstico: {{ match.prediction.homeScore ?? '-' }} - {{ match.prediction.awayScore ?? '-' }}
                  <div class="points-badge" *ngIf="match.prediction?.points !== undefined || match.prediction?.livePoints !== undefined">
                    {{ (match.status.short === 'FT' ? match.prediction.points : match.prediction.livePoints) ?? 0 }} pts
                  </div>
                </div>
              </div>

              <div class="team">
                <img [src]="match.awayTeamLogo" [alt]="match.awayTeam" class="team-logo">
                <div class="team-name">{{ match.awayTeam }}</div>
              </div>
            </div>
          </ion-card-content>
        </ion-card>
      </ion-item>
    </ion-list>
  </div>
</ion-content>