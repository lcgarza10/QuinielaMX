<ion-header>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/home"></ion-back-button>
    </ion-buttons>
    <ion-title>Sube tu Quiniela</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <div class="week-header">
    <div class="round-badge">
      {{ getWeekTitle() }}
      <ion-badge
        [color]="hasPredictions ? 'success' : 'warning'"
        class="round-badge"
      >
        {{ hasPredictions ? 'COMPLETADA' : 'PENDIENTE' }}
      </ion-badge>
    </div>
  </div>

  <app-rounds-selector
    [selectedRound]="selectedRound"
    [currentRound]="currentRound"
    [isLiveRound]="isLiveRound"
    (roundChange)="onRoundChange($event)">
  </app-rounds-selector>

  <div *ngIf="loading" class="loading-container">
    <ion-spinner></ion-spinner>
    <p>Cargando partidos...</p>
  </div>

  <ion-text color="warning" *ngIf="isRateLimited" class="rate-limit-warning">
    <ion-icon name="warning-outline"></ion-icon>
    <p>{{ error }}</p>
  </ion-text>

  <ion-text color="danger" *ngIf="error && !isRateLimited">
    <p>{{ error }}</p>
    <ion-button (click)="loadMatches()" size="small" fill="outline">
      Reintentar
    </ion-button>
  </ion-text>

  <ion-text color="warning" *ngIf="isOffline">
    <p>
      No hay conexión a internet. Algunos datos pueden no estar actualizados.
    </p>
    <ion-button (click)="loadMatches()" size="small" fill="outline">
      Reintentar Conexión
    </ion-button>
  </ion-text>

  <div class="matches-container" *ngIf="!loading && !error">
    <ion-list>
      <ion-item *ngFor="let match of matches">
        <ion-card class="match-card">
          <ion-card-content>
            <div class="teams">
              <div class="team">
                <img
                  [src]="match.homeTeamLogo"
                  [alt]="match.homeTeam"
                  class="team-logo"
                />
                <div class="team-name">{{ match.homeTeam }}</div>
                <div class="team-position" *ngIf="match.homeTeamPosition">
                  {{ match.homeTeamPosition }}{{ getOrdinalSuffix(match.homeTeamPosition) }} Lugar de la Tabla
                </div>
                <app-team-form *ngIf="match.homeTeamForm" [form]="match.homeTeamForm"></app-team-form>
              </div>

              <app-match-prediction
                [match]="match"
                [prediction]="match.prediction"
                [canPredict]="match.canPredict"
                [isCompleted]="hasPredictions"
                (predictionChange)="onPredictionChange(match, $event)"
              >
              </app-match-prediction>

              <div class="team">
                <img
                  [src]="match.awayTeamLogo"
                  [alt]="match.awayTeam"
                  class="team-logo"
                />
                <div class="team-name">{{ match.awayTeam }}</div>
                <div class="team-position" *ngIf="match.awayTeamPosition">
                  {{ match.awayTeamPosition }}{{ getOrdinalSuffix(match.awayTeamPosition) }} Lugar de la Tabla
                </div>
                <app-team-form *ngIf="match.awayTeamForm" [form]="match.awayTeamForm"></app-team-form>
              </div>
            </div>
            <ion-card-header align="center">
              <ion-card-subtitle>
                {{ match.date | date : 'EEEE d MMMM, y' : '' : 'es-MX' }} •
                {{ match.date | date : 'h:mm a' : '' : 'es-MX' }}
                <br />
                <small>{{ match.venue.name }}, {{ match.venue.city }}</small>
              </ion-card-subtitle>
            </ion-card-header>
          </ion-card-content>
        </ion-card>
      </ion-item>
    </ion-list>

    <ion-button
      expand="block"
      (click)="submitPredictions()"
      [disabled]="isSubmitDisabled()"
      class="submit-button"
      *ngIf="!hasPredictions"
    >
      Guardar Predicciones
    </ion-button>
  </div>

  <ion-segment [(ngModel)]="selectedView">
    <ion-segment-button value="regular">
      Regular
    </ion-segment-button>
    <ion-segment-button value="playoffs">
      Playoffs
    </ion-segment-button>
  </ion-segment>

  <app-match-list
    *ngIf="selectedView === 'regular'"
    [matches]="matches"
    [isCompleted]="!isLiveRound"
    [weeklyPoints]="weeklyPoints"
    [weekLabel]="selectedRound.toString()"
    (submitPredictions)="submitPredictions()"
  ></app-match-list>

  <app-match-list
    *ngIf="selectedView === 'playoffs'"
    [matches]="playoffMatches"
    [isCompleted]="!isLiveRound"
    [weeklyPoints]="weeklyPoints"
    [weekLabel]="'Playoffs'"
    (submitPredictions)="submitPredictions()"
  ></app-match-list>
</ion-content>