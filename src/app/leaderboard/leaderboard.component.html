<ion-header>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/home"></ion-back-button>
    </ion-buttons>
    <ion-title>Tabla General</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <div class="leaderboard-container">
    <ion-segment [(ngModel)]="selectedView" (ionChange)="onViewChange()" mode="ios" class="custom-segment">
      <ion-segment-button value="weekly">
        <ion-label>
          <ion-icon name="calendar-outline"></ion-icon>
          Jornada
        </ion-label>
      </ion-segment-button>
      <ion-segment-button value="overall">
        <ion-label>
          <ion-icon name="trophy-outline"></ion-icon>
          General
        </ion-label>
      </ion-segment-button>
    </ion-segment>

    <ng-container *ngIf="selectedView === 'weekly'">
      <div class="round-info">
        <div class="round-status">
          {{ getRoundStatus() }}
          <ion-badge [color]="isCurrentRoundActive ? 'success' : 'medium'" class="round-badge">
            {{ isCurrentRoundActive ? 'EN VIVO' : 'FINALIZADA' }}
          </ion-badge>
        </div>
      </div>

      <app-rounds-selector
        [selectedRound]="selectedRound"
        [currentRound]="currentRound"
        [isLiveRound]="isCurrentRoundActive"
        (roundChange)="onRoundChange($event)">
      </app-rounds-selector>
    </ng-container>

    <ng-container *ngIf="!(loading || error)">
      <ng-container *ngIf="selectedView === 'weekly'; else overallView">
        <ng-container *ngIf="weeklyLeaderboard$ | async as weeklyLeaderboard">
          <div class="leaderboard-content">
            <div class="stats-summary">
              <div class="stat-card">
                <div class="stat-value">{{ getLeaderPoints(weeklyLeaderboard) }}</div>
                <div class="stat-label">Puntos Líder</div>
              </div>
              <div class="stat-card">
                <div class="stat-value">{{ weeklyLeaderboard.length }}</div>
                <div class="stat-label">Participantes</div>
              </div>
            </div>

            <div class="leaderboard-list">
              <ion-list>
                <ion-item *ngFor="let entry of weeklyLeaderboard; let i = index" lines="full" class="leaderboard-item" [class.top-three]="i < 3">
                  <div class="position" [class.first]="i === 0" [class.second]="i === 1" [class.third]="i === 2">{{ i + 1 }}</div>
                  <ion-label>
                    <div class="user-row">
                      <h2>{{ entry.username }}</h2>
                      <span class="points" [class.top-points]="i === 0">{{ entry.weeklyPoints }} pts</span>
                    </div>
                  </ion-label>
                </ion-item>
              </ion-list>
            </div>

            <div class="empty-state" *ngIf="weeklyLeaderboard.length === 0">
              <ion-icon name="people-outline" class="empty-icon"></ion-icon>
              <h2>No hay participantes</h2>
              <p>Los resultados aparecerán cuando los usuarios empiecen a participar</p>
            </div>
          </div>
        </ng-container>
      </ng-container>

      <ng-template #overallView>
        <ng-container *ngIf="overallLeaderboard$ | async as overallLeaderboard">
          <div class="leaderboard-content">
            <div class="stats-summary">
              <div class="stat-card">
                <div class="stat-value">{{ getLeaderPoints(overallLeaderboard) }}</div>
                <div class="stat-label">Puntos Líder</div>
              </div>
              <div class="stat-card">
                <div class="stat-value">{{ overallLeaderboard.length }}</div>
                <div class="stat-label">Participantes</div>
              </div>
            </div>

            <div class="leaderboard-list">
              <ion-list>
                <ion-item *ngFor="let entry of overallLeaderboard; let i = index" lines="full" class="leaderboard-item" [class.top-three]="i < 3">
                  <div class="position" [class.first]="i === 0" [class.second]="i === 1" [class.third]="i === 2">{{ i + 1 }}</div>
                  <ion-label>
                    <div class="user-row">
                      <h2>{{ entry.username }}</h2>
                      <span class="points" [class.top-points]="i === 0">{{ entry.totalPoints }} pts</span>
                    </div>
                  </ion-label>
                </ion-item>
              </ion-list>
            </div>

            <div class="empty-state" *ngIf="overallLeaderboard.length === 0">
              <ion-icon name="people-outline" class="empty-icon"></ion-icon>
              <h2>No hay participantes</h2>
              <p>Los resultados aparecerán cuando los usuarios empiecen a participar</p>
            </div>
          </div>
        </ng-container>
      </ng-template>
    </ng-container>
  </div>
</ion-content>